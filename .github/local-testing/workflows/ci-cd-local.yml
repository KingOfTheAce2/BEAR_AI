name: BEAR AI - Local CI/CD Testing

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  LOCAL_TESTING: true
  SKIP_EXTERNAL_CALLS: true

jobs:
  # Quick validation for local testing
  pre-flight:
    name: Pre-flight Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate configuration files
        run: |
          echo "ðŸ” Validating project configuration..."

          # Check package.json
          if [[ -f "package.json" ]]; then
            echo "âœ… package.json found"
            node -e "JSON.parse(require('fs').readFileSync('package.json', 'utf8'))" || {
              echo "âŒ package.json is invalid"
              exit 1
            }
          else
            echo "âŒ package.json not found"
            exit 1
          fi

          # Check Cargo.toml
          if [[ -f "src-tauri/Cargo.toml" ]]; then
            echo "âœ… Cargo.toml found"
          else
            echo "âŒ Cargo.toml not found"
            exit 1
          fi

          # Check workflow files
          echo "ðŸ“ Workflow files:"
          ls -la .github/workflows/

          echo "ðŸŽ¯ Pre-flight checks completed successfully"

  # Optimized quality checks for local testing
  quality-checks-local:
    name: Quality Checks (Local)
    needs: [pre-flight]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            src-tauri/target/
            node_modules/
          key: ${{ runner.os }}-deps-${{ hashFiles('**/Cargo.lock', '**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-deps-

      - name: Install dependencies (with retry)
        run: |
          echo "ðŸ“¦ Installing dependencies..."
          npm ci --prefer-offline --no-audit || {
            echo "âš ï¸  npm ci failed, trying fallback strategies..."
            npm cache clean --force
            npm ci --prefer-offline --no-audit || {
              echo "âš ï¸  Trying npm install..."
              npm install --no-audit
            }
          }

      - name: TypeScript type checking
        run: |
          echo "ðŸ” Running TypeScript checks..."
          npm run typecheck

      - name: ESLint (with error tolerance for local testing)
        run: |
          echo "ðŸ” Running ESLint..."
          npm run lint || {
            echo "âš ï¸  ESLint found issues, but continuing for local testing"
            echo "Please fix these issues before production deployment"
          }

      - name: Rust formatting check
        working-directory: src-tauri
        run: |
          echo "ðŸ¦€ Checking Rust formatting..."
          cargo fmt --all -- --check || {
            echo "âš ï¸  Rust formatting issues found"
            echo "Run 'cargo fmt' to fix formatting"
          }

      - name: Rust linting
        working-directory: src-tauri
        run: |
          echo "ðŸ¦€ Running Rust linting..."
          cargo clippy --all-targets --all-features -- -D warnings

      - name: Run tests (quick mode)
        run: |
          echo "ðŸ§ª Running tests in quick mode..."
          export QUICK_TEST=true
          npm test || echo "âš ï¸  Some tests failed - review before production"

      - name: Rust tests
        working-directory: src-tauri
        run: |
          echo "ðŸ¦€ Running Rust tests..."
          cargo test --release

  # Single platform build for faster local testing
  build-local:
    name: Local Build Test
    needs: [quality-checks-local]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install system dependencies
        run: |
          echo "ðŸ”§ Installing system dependencies..."
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.0-dev \
            librsvg2-dev \
            libayatana-appindicator3-dev \
            libxdo-dev

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            src-tauri/target/
            node_modules/
          key: ${{ runner.os }}-build-${{ hashFiles('**/Cargo.lock', '**/package-lock.json') }}

      - name: Install frontend dependencies
        run: |
          echo "ðŸ“¦ Installing frontend dependencies..."
          npm ci --prefer-offline --no-audit

      - name: Build frontend
        run: |
          echo "ðŸ—ï¸  Building frontend..."
          npm run build

      - name: Build Tauri app (debug mode for speed)
        run: |
          echo "ðŸ—ï¸  Building Tauri application..."
          cd src-tauri
          cargo build --features custom-protocol

      - name: Validate build artifacts
        run: |
          echo "ðŸ” Validating build artifacts..."

          # Check frontend build
          if [[ -d "build" ]]; then
            echo "âœ… Frontend build directory exists"
            echo "ðŸ“Š Build size: $(du -sh build | cut -f1)"
          else
            echo "âŒ Frontend build failed"
            exit 1
          fi

          # Check Rust binary
          if [[ -f "src-tauri/target/debug/bear-ai-legal-assistant" ]] || [[ -f "src-tauri/target/debug/bear-ai-legal-assistant.exe" ]]; then
            echo "âœ… Rust binary built successfully"
          else
            echo "âŒ Rust binary build failed"
            exit 1
          fi

          echo "ðŸŽ‰ Local build test completed successfully!"

  # Generate local testing report
  test-report:
    name: Generate Test Report
    needs: [build-local]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate test summary
        run: |
          echo "# ðŸ» BEAR AI Local Testing Report" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Platform:** Local Testing Environment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Job status checks
          if [[ "${{ needs.build-local.result }}" == "success" ]]; then
            echo "âœ… **Build Test:** Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Build Test:** Failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“‹ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "- Run full multi-platform testing with: \`act -j build-tauri\`" >> $GITHUB_STEP_SUMMARY
          echo "- Test release workflow with: \`act -j release\`" >> $GITHUB_STEP_SUMMARY
          echo "- Check performance metrics in: \`.github/local-testing/metrics/\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ¯ **Local testing completed successfully!**" >> $GITHUB_STEP_SUMMARY